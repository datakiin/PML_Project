---
title: "Using Sensor Data to Predict Proper Exercise Technique"
author: "Kamran Haroon"
date: "December 27, 2015"
output: html_document
---


## Summary

The purpose of this project is to predict if subjects have performed a physical exercise correctly using data from multiple motion sensors. The training and test datasets are processed by removing columns that are not used to train our models. We consider multiple approaches and select a random forest algorithm that yields an accuracy of 99% on the test set. As a final validation, the selected model is used on 20 tests on a newer unseen dataset. 

The training data for this project are available here: 

https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv

The test data are available here: 

https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv


## Data Processing

The data for this project came from a research project focused on Human Activity Recognition (HAR).  The participants in the study were asked to perform bicep curls correctly and incorrectly in 5 different ways.  Each way is considered a class, A-F, and recorded in the classe variable of the data set.

* Class A: exactly according to the specification
* Class B: throwing the elbows to the front
* Class C: lifting the dumbbell only halfway
* Class D: lowering the dumbbell only halfway 
* Class E: throwing the hips to the front 

The sensor data was recorded by accelerometers on the participant's belt, forearm, arm, and dumbell.  For more detail see  http://groupware.les.inf.puc-rio.br/har.  
```{r loadtraindata, echo = TRUE}

set.seed(12345)

# Verify the training/test data has been downloaded into a data folder in the working directory
if (!file.exists("./data/pml-training.csv")) {
        dataUrl = "https://d396qusza40orc.cloudfront.net/predmachlearn/
        pml-training.csv"
        download.file(dataUrl, destfile = "./data/pml-training.csv", method =
                              "curl")
        }

if (!file.exists("./data/pml-testing.csv")) {
        dataUrl = "https://d396qusza40orc.cloudfront.net/predmachlearn/
        pml-testing.csv"
        download.file(dataUrl, destfile = "./data/pml-testing.csv", method =
                              "curl")
        }

# Load in the data
pmlTrain <- read.csv("./data/pml-training.csv", header = TRUE)
pmlTest <- read.csv("./data/pml-testing.csv", header = TRUE)
dim(pmlTrain)
dim(pmlTest)
```


### Feature Selection
We remove columns from the training data that are not used to train the model.  Apparently, NA values cannot be used as predictors because errors result from thier inclusion in the model. Thus the test columns with all NAs are pruned from the training data.
```{r featureselection, echo = FALSE, message = FALSE}
library(dplyr)
library(caret)

# List the test columns with NA in the column
naNames <- names(pmlTest[, colSums(is.na(pmlTest)) == nrow(pmlTest)])
  
# Remove columns from the training set that are NA in the test set 
pmlTrain <- pmlTrain[,-which(names(pmlTrain) %in% naNames)]
```

Next we remove columns like user_name, time stamps, and window columns as predictors so that our model is based solely on the sensor data.  

```{r reducepredicters, echo = TRUE}
# Keep only the sensor data columns and classe 
pmlTrain <- select(pmlTrain, roll_belt:classe)
names(pmlTrain)
```


### Exploratory Analysis

```{r exploredata, echo = TRUE}
library(ggplot2)
qplot(roll_belt, pitch_belt, colour=classe, data=pmlTrain)
```

### Cross Validation 

The training set is further split into two data sets using the standard 60/40 split for cross validation.  This way we can run initial testing on the model and estimate the out of sample error before we run the final test.   
```{r splitdata, echo = TRUE}
inTrain <- createDataPartition(y=pmlTrain$classe, p=0.60, list=FALSE)
training <- pmlTrain[inTrain,] 
dim(training)
testing <- pmlTrain[-inTrain,] 
dim(testing)
```

## Model Creation

### Random Forest

```{r trainmodel, echo = TRUE, cache=TRUE}
library(randomForest)
model <- train(classe ~ ., data = training, method = 'rf')
                  
model
model$finalModel
```


### Model Verification and Accuracy

We now use the test data segregated for cross validation to gauge our model's accuracy.  The confusion matrix shows the matrix of the predictions versus the reference Classes A-E. The accuracy of our model comes out to approx 99%.

```{r verifymodel, echo=TRUE}
predictions <- predict(model, testing)  confusionMatrix(predictions,testing$classe)
```

### Out of sample Error

As out of sample error can be defined as (1 - accuracy), the out of sample error for our model comes out to (1.00 - 0.9922 = ) 0.78%


## Application on Test Cases

```{r, finalpredictions, echo=TRUE}
predictFinal <- predict(model, pmlTest)
predictFinal

results <- "./results"
if(!file.exists(results)) {dir.create(results)}

pml_write_files = function(x){
  n = length(x)
  for(i in 1:n){
    filename = paste0("problem_id_",i,".txt")
    write.table(x[i],file=filename,quote=FALSE,row.names=FALSE,col.names=FALSE)
  }
}


pml_write_file(predictFinal,results)
```